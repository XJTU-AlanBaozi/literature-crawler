<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搜索结果 - AI文献爬虫系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .literature-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .literature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .literature-title {
            color: #2c5aa0;
            font-size: 1.2rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
        }
        .literature-title:hover {
            color: #1e3d72;
            text-decoration: underline;
        }
        .literature-meta {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 8px;
        }
        .literature-abstract {
            color: #495057;
            line-height: 1.6;
            margin-top: 10px;
        }
        .search-header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .pagination-info {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 50px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .literature-item {
            transition: all 0.3s ease;
        }
        .literature-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .pagination-info {
            margin-top: 20px;
            text-align: center;
            color: #6c757d;
        }

        .progress-container {
            margin-bottom: 20px;
        }
        .progress {
            height: 25px;
        }
        .progress-bar {
            font-size: 14px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-journal-text"></i>
                AI文献爬虫系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">返回首页</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- 搜索头部 -->
        <div class="search-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-2">
                        <i class="bi bi-search"></i>
                        搜索结果
                    </h4>
                    <p class="mb-0">
                        关键词: <strong th:text="${query}"></strong>
                        <span class="pagination-info ms-3">
                            共找到 <span th:text="${totalResults}"></span> 条结果
                        </span>
                    </p>
                </div>
                <div class="col-md-4">
                    <form action="/search" method="get" class="d-flex">
                        <input type="text" name="query" class="form-control me-2" th:value="${query}" placeholder="重新搜索...">
                        <button type="submit" class="btn btn-primary">搜索</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 进度条 -->
        <div id="progressContainer" class="row mb-4" style="display: none;">
            <div class="col-md-8 offset-md-2">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">正在爬取数据...</h5>
                        <div class="progress mb-2">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="mb-0">准备开始...</p>
                        <p id="progressTime" class="text-muted small mb-0"></p>
                    </div>
                </div>
            </div>
        </div>

    

        <!-- 搜索结果列表 -->
        <div class="results-container" id="resultsContainer">
            <div th:each="literature : ${results.content}" class="literature-card">
                <div class="row">
                    <div class="col-12">
                        <h5>
                            <a th:href="${'/literature/' + literature.id}" class="literature-title" 
                               th:text="${literature.title}">
                            </a>
                        </h5>
                        <div class="literature-meta">
                            <span><i class="bi bi-person"></i> <span th:text="${literature.authors}"></span></span>
                            <span class="ms-3"><i class="bi bi-calendar"></i> <span th:text="${#temporals.format(literature.publicationDate, 'yyyy-MM-dd')}"></span></span>
                            <span class="ms-3"><i class="bi bi-journal"></i> <span th:text="${literature.journal}"></span></span>
                            <span class="ms-3"><i class="bi bi-hash"></i> PMID: <span th:text="${literature.pmid}"></span></span>
                        </div>
                        <div class="literature-abstract" th:if="${literature.abstractText}">
                            <strong>摘要:</strong> <span th:text="${#strings.abbreviate(literature.abstractText, 500)}"></span>
                        </div>
                        <div class="mt-3">
                            <span th:if="${literature.keywords}" class="badge bg-primary me-2">
                                <i class="bi bi-tag"></i> 关键词
                            </span>
                            <span th:if="${literature.affiliation}" class="badge bg-success me-2">
                                <i class="bi bi-building"></i> 机构信息
                            </span>
                            <span th:if="${literature.doi}" class="badge bg-info">
                                <i class="bi bi-link"></i> DOI
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分页 -->
        <div class="d-flex justify-content-center mt-4" th:if="${totalPages > 1}">
            <nav aria-label="搜索结果分页">
                <ul class="pagination">
                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link" th:href="@{/search(query=${query}, page=${currentPage - 1})}">
                            <i class="bi bi-chevron-left"></i> 上一页
                        </a>
                    </li>
                    
                    <li th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}" 
                        class="page-item" 
                        th:classappend="${pageNum == currentPage} ? 'active'">
                        <a class="page-link" th:href="@{/search(query=${query}, page=${pageNum})}" th:text="${pageNum + 1}"></a>
                    </li>
                    
                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                        <a class="page-link" th:href="@{/search(query=${query}, page=${currentPage + 1})}">
                            下一页 <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 搜索表单提交
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (searchTerm) {
                searchLiterature(searchTerm, 0);
                startProgressMonitoring(searchTerm);
            }
        });
        
        // 进度监控
        let progressInterval;
        
        function startProgressMonitoring(searchTerm) {
            // 显示进度条
            document.getElementById('progressContainer').style.display = 'block';
            
            // 开始轮询进度
            progressInterval = setInterval(() => {
                fetch(`/api/crawl-progress/${encodeURIComponent(searchTerm)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data) {
                            updateProgressBar(data.data);
                            
                            // 如果爬取完成或失败，停止轮询
                            if (data.data.status === 'completed' || data.data.status === 'failed') {
                                clearInterval(progressInterval);
                                setTimeout(() => {
                                    document.getElementById('progressContainer').style.display = 'none';
                                }, 3000);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('获取进度失败:', error);
                        clearInterval(progressInterval);
                    });
            }, 1000); // 每秒更新一次
        }
        
        function updateProgressBar(progress) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressTime = document.getElementById('progressTime');
            
            // 更新进度条
            const percentage = progress.total > 0 ? (progress.current / progress.total * 100) : 0;
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
            
            // 更新文本
            progressText.textContent = progress.message || '正在处理...';
            
            // 更新时间
            if (progress.startTime) {
                const elapsed = new Date() - new Date(progress.startTime);
                const elapsedStr = formatTime(elapsed);
                progressTime.textContent = `已用时: ${elapsedStr}`;
            }
            
            // 根据状态改变颜色
            if (progress.status === 'failed') {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
            } else if (progress.status === 'completed') {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
            }
        }
        
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}小时 ${minutes % 60}分钟`;
            } else if (minutes > 0) {
                return `${minutes}分钟 ${seconds % 60}秒`;
            } else {
                return `${seconds}秒`;
            }
        }
    </script>
</body>
</html>